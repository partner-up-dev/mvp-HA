# Backend Continuous Deployment (Aliyun FC + Serverless Devs)

This repository deploys the backend to Aliyun Function Compute (FC) using **Serverless Devs** via GitHub Actions.
The backend runs as a normal HTTP server on **custom Debian 12 runtime with Node.js 22**, and **node_modules are supplied by a custom layer** (so they are not bundled with the deployment package).

## Overview

- Workflow: `.github/workflows/backend-fc-deploy.yml` (publishes the node_modules layer first, then deploys backend)
- Serverless Devs config: `apps/backend/s.yaml`
- Deployment package (generated by CI): `apps/backend/.fc-package`

## GitHub Actions Secrets

Configure the following secrets in the GitHub repository:

| Secret | Description |
| --- | --- |
| `ALIBABA_CLOUD_ACCESS_KEY_ID` | Alibaba Cloud AccessKey ID |
| `ALIBABA_CLOUD_ACCESS_KEY_SECRET` | Alibaba Cloud AccessKey Secret |
| `ALIBABA_CLOUD_ACCOUNT_ID` | Alibaba Cloud Account ID |
| `ALIYUN_FC_REGION` | FC region (e.g. `cn-hangzhou`) |
| `ALIYUN_FC_FUNCTION_NAME` | FC function name to deploy |
| `ALIYUN_FC_NODE_MODULES_LAYER_NAME` | FC layer name for publishing backend `node_modules` |
| `ALIYUN_FC_ROLE_ARN` | RAM role ARN for the function |
| `ALIYUN_FC_RESOURCE_GROUP_ID` | Resource group ID |
| `ALIYUN_FC_LOG_PROJECT` | Log service project name |
| `ALIYUN_FC_LOG_STORE` | Log service logstore name |
| `ALIYUN_FC_OSS_ENDPOINT` | OSS internal endpoint used for OSS mount |
| `ALIYUN_FC_OSS_BUCKET` | OSS bucket name to mount |
| `ALIYUN_FC_OSS_BUCKET_PATH` | OSS bucket path (use `/` to mount the bucket root) |
| `ALIYUN_FC_PATH` | PATH value for the runtime (match the FC console export) |
| `DATABASE_URL` | Database connection string |
| `WECHAT_OFFICIAL_ACCOUNT_APP_ID` | WeChat Official Account App ID |
| `WECHAT_OFFICIAL_ACCOUNT_APP_SECRET` | WeChat Official Account App Secret |
| `WECHAT_HTTP_PROXY` | Optional HTTP proxy for WeChat API requests |
| `LLM_API_KEY` | LLM API key |
| `LLM_BASE_URL` | LLM base URL |
| `LLM_DEFAULT_MODEL` | LLM default model |

## Packaging Notes

The workflow builds the backend with `pnpm --filter @partner-up-dev/backend build`, then creates a minimal deployment package:

```
apps/backend/.fc-package/
  dist/
  fc-start.sh
  package.json
```

`fc-start.sh` sets `PATH` to the runtime layer and symlinks `/opt/nodejs/node_modules` into the function directory, so the custom `node_modules` layer is used at runtime.

## Node Modules Layer Deployment

The deploy workflow first builds and publishes a dedicated FC layer that contains production `node_modules` for the backend. It then resolves the latest layer ARN (including the version suffix) and passes it to `s deploy` via `ALIYUN_FC_NODE_MODULES_LAYER_ARN`, so backend deployments always use the freshly published layer without needing persisted GitHub variables or repo commits.

Helper scripts (used by CI) live in:

- `scripts/fc_layer_latest_arn.py`
- `scripts/fc_layer_prune_versions.py`

## Custom Runtime Settings

The FC configuration in `apps/backend/s.yaml` uses:

- `runtime: custom.debian12`
- `customRuntimeConfig.port: 3000`
- `PORT=3000` in environment variables
- `layers` to attach the `node_modules` layer
- `ossMountConfig` to mount the OSS bucket at `/mnt/oss`
- `disableURLInternet: false` to match the console export's public URL setting

## Manual Deployment

If you need to deploy locally (with Serverless Devs installed):

1. Build and package the backend:

   ```bash
   pnpm --filter @partner-up-dev/backend build
   rm -rf apps/backend/.fc-package
   mkdir -p apps/backend/.fc-package
   cp -R apps/backend/dist apps/backend/.fc-package/
   cp apps/backend/package.json apps/backend/fc-start.sh apps/backend/.fc-package/
   ```

2. Configure `s` credentials (once per machine):

   ```bash
   s config add --AccessKeyID <id> --AccessKeySecret <secret> --AccountID <account>
   ```

3. Deploy:

   ```bash
   ALIYUN_FC_REGION=... \
   ALIYUN_FC_FUNCTION_NAME=... \
   ALIYUN_FC_NODE_MODULES_LAYER_ARN=... \
   ALIYUN_FC_ROLE_ARN=... \
   ALIYUN_FC_RESOURCE_GROUP_ID=... \
   ALIYUN_FC_LOG_PROJECT=... \
   ALIYUN_FC_LOG_STORE=... \
   ALIYUN_FC_OSS_ENDPOINT=... \
   ALIYUN_FC_OSS_BUCKET=... \
   ALIYUN_FC_OSS_BUCKET_PATH=/ \
   ALIYUN_FC_PATH=... \
   DATABASE_URL=... \
   WECHAT_OFFICIAL_ACCOUNT_APP_ID=... \
   WECHAT_OFFICIAL_ACCOUNT_APP_SECRET=... \
   WECHAT_HTTP_PROXY=... \
   LLM_API_KEY=... \
   LLM_BASE_URL=... \
   LLM_DEFAULT_MODEL=... \
   s deploy -y -t apps/backend/s.yaml
   ```

### Manual Layer Deployment

1. Build the production `node_modules` layer directory:

   ```bash
   pnpm -C apps/backend install --prod --frozen-lockfile --node-linker=hoisted
   rm -rf apps/backend/.layer
   mkdir -p apps/backend/.layer/nodejs
   cp -R apps/backend/node_modules apps/backend/.layer/nodejs/node_modules
   ```

2. Publish the layer:

   ```bash
   ALIYUN_FC_REGION=... \
   ALIYUN_FC_NODE_MODULES_LAYER_NAME=... \
   s cli fc3 layer publish \
     --region "$ALIYUN_FC_REGION" \
     --layer-name "$ALIYUN_FC_NODE_MODULES_LAYER_NAME" \
     --code apps/backend/.layer \
     --compatible-runtime custom.debian12 \
     --description "PartnerUp backend production node_modules" \
     -a default
   ```

3. Resolve the latest versioned layer ARN and deploy:

   ```bash
   ALIYUN_FC_NODE_MODULES_LAYER_ARN=$(python3 scripts/fc_layer_latest_arn.py \
     --region "$ALIYUN_FC_REGION" \
     --layer-name "$ALIYUN_FC_NODE_MODULES_LAYER_NAME" \
     --access default) \
   s deploy -y -t apps/backend/s.yaml
   ```

4. (Optional) Clean up old layer versions (keep 3):

   ```bash
   python3 scripts/fc_layer_prune_versions.py \
     --region "$ALIYUN_FC_REGION" \
     --layer-name "$ALIYUN_FC_NODE_MODULES_LAYER_NAME" \
     --keep 3 \
     --access default
   ```
