# Backend Continuous Deployment (Aliyun FC + Serverless Devs)

This repository deploys the backend to Aliyun Function Compute (FC) using **Serverless Devs** via GitHub Actions.
The backend runs as a normal HTTP server on **custom Debian 11 runtime with Node.js 22**, and **node_modules are supplied by a custom layer** (so they are not bundled with the deployment package).

## Overview

- Workflow: `.github/workflows/backend-fc-deploy.yml`
- Node modules layer workflow: `.github/workflows/backend-fc-layer-deploy.yml`
- Serverless Devs config: `apps/backend/s.yaml`
- Node modules layer config: `apps/backend/layers/node-modules/s.yaml`
- Deployment package (generated by CI): `apps/backend/.fc-package`

## GitHub Actions Secrets

Configure the following secrets in the GitHub repository:

| Secret | Description |
| --- | --- |
| `ALIBABA_CLOUD_ACCESS_KEY_ID` | Alibaba Cloud AccessKey ID |
| `ALIBABA_CLOUD_ACCESS_KEY_SECRET` | Alibaba Cloud AccessKey Secret |
| `ALIBABA_CLOUD_ACCOUNT_ID` | Alibaba Cloud Account ID |
| `ALIYUN_FC_REGION` | FC region (e.g. `cn-hangzhou`) |
| `ALIYUN_FC_FUNCTION_NAME` | FC function name to deploy |
| `ALIYUN_FC_NODE_RUNTIME_LAYER_ARN` | Custom layer ARN that provides Node.js 22 runtime (Debian 11) |
| `ALIYUN_FC_NODE_MODULES_LAYER_ARN` | Custom layer ARN that provides `node_modules` |
| `ALIYUN_FC_NODE_MODULES_LAYER_NAME` | FC layer name for publishing backend `node_modules` |
| `ALIYUN_FC_VPC_ID` | VPC ID for accessing the VPS network |
| `ALIYUN_FC_SECURITY_GROUP_ID` | Security group ID for the function VPC network |
| `ALIYUN_FC_VSWITCH_ID` | VSwitch ID for the function VPC network |
| `ALIYUN_FC_OSS_ENDPOINT` | OSS internal endpoint used for OSS mount |
| `ALIYUN_FC_OSS_BUCKET` | OSS bucket name to mount |
| `ALIYUN_FC_OSS_BUCKET_PATH` | OSS bucket path (use `/` to mount the bucket root) |

## Packaging Notes

The workflow builds the backend with `pnpm --filter @partner-up-dev/backend build`, then creates a minimal deployment package:

```
apps/backend/.fc-package/
  dist/
  fc-start.sh
  package.json
```

`fc-start.sh` sets `PATH` to the runtime layer and symlinks `/opt/nodejs/node_modules` into the function directory, so the custom `node_modules` layer is used at runtime.

## Node Modules Layer Deployment

The layer workflow publishes a dedicated FC layer that contains production `node_modules` for the backend. It only runs when `apps/backend/package.json`, `pnpm-lock.yaml`, or the layer configuration changes, so the layer isn't rebuilt during normal backend deployments.

After a successful layer deployment, update `ALIYUN_FC_NODE_MODULES_LAYER_ARN` to the new layer version ARN produced by the workflow logs.

## Custom Runtime Settings

The FC configuration in `apps/backend/s.yaml` uses:

- `runtime: custom.debian11`
- `customRuntimeConfig.port: 9000`
- `PORT=9000` in environment variables
- `layers` to attach Node.js 22 runtime + `node_modules` layers
- `vpcConfig` to connect to the VPS network (no public URL exposed)
- `ossMountConfig` to mount the OSS bucket at `/mnt/OSS`

## Manual Deployment

If you need to deploy locally (with Serverless Devs installed):

1. Build and package the backend:
   ```bash
   pnpm --filter @partner-up-dev/backend build
   rm -rf apps/backend/.fc-package
   mkdir -p apps/backend/.fc-package
   cp -R apps/backend/dist apps/backend/.fc-package/
   cp apps/backend/package.json apps/backend/fc-start.sh apps/backend/.fc-package/
   ```
2. Configure `s` credentials (once per machine):
   ```bash
   s config add --AccessKeyID <id> --AccessKeySecret <secret> --AccountID <account> --Alias default
   ```
3. Deploy:
   ```bash
   ALIYUN_FC_REGION=... \
   ALIYUN_FC_FUNCTION_NAME=... \
   ALIYUN_FC_NODE_RUNTIME_LAYER_ARN=... \
   ALIYUN_FC_NODE_MODULES_LAYER_ARN=... \
   ALIYUN_FC_VPC_ID=... \
   ALIYUN_FC_SECURITY_GROUP_ID=... \
   ALIYUN_FC_VSWITCH_ID=... \
   ALIYUN_FC_OSS_ENDPOINT=... \
   ALIYUN_FC_OSS_BUCKET=... \
   ALIYUN_FC_OSS_BUCKET_PATH=/ \
   s deploy -y -t apps/backend/s.yaml
   ```

### Manual Layer Deployment

1. Build the production `node_modules` layer directory:
   ```bash
   pnpm -C apps/backend install --prod --frozen-lockfile --node-linker=hoisted
   rm -rf apps/backend/.layer
   mkdir -p apps/backend/.layer/nodejs
   cp -R apps/backend/node_modules apps/backend/.layer/nodejs/node_modules
   ```
2. Deploy the layer:
   ```bash
   ALIYUN_FC_REGION=... \
   ALIYUN_FC_NODE_MODULES_LAYER_NAME=... \
   s deploy -y -t apps/backend/layers/node-modules/s.yaml
   ```

## Fixed Public IP Notes

To use a fixed outbound public IP while keeping public ingress disabled, configure the VPC with a NAT gateway + EIP and route outbound traffic through it. The function is attached to the VPC via `vpcConfig` and the HTTP trigger disables the public URL, so the app is reachable only through private networking or internal routing. Ensure the VSwitch and security group allow access to the VPS network and the NAT gateway.
