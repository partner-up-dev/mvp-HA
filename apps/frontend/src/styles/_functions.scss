/*
 * SCSS Functions and Mixins for Design Tokens
 * Utility functions for accessing and emitting tokens
 */

@use 'sass:meta';
@use 'sass:map';
@use 'sass:list';
@use 'sass:string';

/// Deep getter for arbitrarily nested token maps
/// @param {Map} $map - The map to search
/// @param {String...} $keys - Keys to traverse
/// @return {*} - The value at the nested path, or null if not found
/// @example
///   $color: map-deep-get($ref-tokens, color, primary, 80);
@function map-deep-get($map, $keys...) {
  $value: $map;
  @each $key in $keys {
    @if meta.type-of($value) == "map" and map.has-key($value, $key) {
      $value: map.get($value, $key);
    } @else {
      @return null;
    }
  }
  @return $value;
}

/// Generate a CSS variable name from namespace and path
/// @param {String} $namespace - The namespace prefix (e.g., 'sys', 'ref', 'comp')
/// @param {List} $path - List of path segments
/// @return {String} - CSS variable name (e.g., '--sys-color-primary')
@function token-name($namespace, $path) {
  $name: '--#{$namespace}';
  @each $segment in $path {
    $name: #{$name}-#{$segment};
  }
  @return $name;
}

/// Emit CSS variables from a nested token map (W3C DTCG compatible)
/// Recursively traverses the map and emits CSS variables for leaf values
/// @param {Map} $token-map - The token map to emit
/// @param {String} $namespace - The namespace prefix (default: 'sys')
/// @param {List} $path - Current path (internal use)
/// @output CSS custom properties
@mixin emit-css-variables($token-map, $namespace: "sys", $path: ()) {
  @each $key, $value in $token-map {
    $next-path: list.append($path, $key);
    @if meta.type-of($value) == "map" {
      @include emit-css-variables($value, $namespace, $next-path);
    } @else if meta.type-of($value) == "list" and list.length($value) == 0 {
      // Skip empty lists (which is how SCSS represents empty maps)
    } @else {
      #{token-name($namespace, $next-path)}: #{$value};
    }
  }
}

/// Simple one-level CSS variable emission
/// @param {Map} $map - The flat map to emit
/// @param {String} $prefix - The variable prefix (default: 'sys')
/// @output CSS custom properties
@mixin emit-css-vars($map, $prefix: 'sys') {
  @each $key, $value in $map {
    --#{$prefix}-#{$key}: #{$value};
  }
}

/// Emit nested CSS variables (for maps with sub-maps, one level deep)
/// @param {Map} $map - The map to emit
/// @param {String} $prefix - The variable prefix (default: 'sys')
/// @output CSS custom properties
@mixin emit-nested-css-vars($map, $prefix: 'sys') {
  @each $category, $items in $map {
    @if meta.type-of($items) == 'map' {
      @each $key, $value in $items {
        --#{$prefix}-#{$category}-#{$key}: #{$value};
      }
    } @else {
      --#{$prefix}-#{$category}: #{$items};
    }
  }
}

/// Helper to reference system-level CSS custom properties in components
/// @param {String...} $path - Path segments for the token
/// @return {String} - CSS var() reference
/// @example
///   color: sys-var(color, primary);
///   // Returns: var(--sys-color-primary)
@function sys-var($path...) {
  @return var(#{token-name("sys", $path)});
}

/// Helper to reference reference-level values directly
/// @param {String...} $path - Path segments for the token
/// @return {String} - CSS var() reference
/// @example
///   color: ref-var(color, primary, 80);
///   // Returns: var(--ref-color-primary-80)
@function ref-var($path...) {
  @return var(#{token-name("ref", $path)});
}

/// Convert component token paths into CSS variable references
/// @param {String...} $path - Path segments for the token
/// @return {String} - CSS var() reference
/// @example
///   color: comp-var(button, color, primary-bg);
///   // Returns: var(--comp-button-color-primary-bg)
@function comp-var($path...) {
  @return var(#{token-name("comp", $path)});
}
