edition: 3.0.0
name: partnerup-backend
access: default

vars:
  region: ${env('ALIYUN_FC_REGION')}
  functionName: ${env('ALIYUN_FC_FUNCTION_NAME')}
  nodeModulesLayerArn: ${env('ALIYUN_FC_NODE_MODULES_LAYER_ARN')}
  roleArn: ${env('ALIYUN_FC_ROLE_ARN')}
  resourceGroupId: ${env('ALIYUN_FC_RESOURCE_GROUP_ID')}
  logProject: ${env('ALIYUN_FC_LOG_PROJECT')}
  logStore: ${env('ALIYUN_FC_LOG_STORE')}
  vpcId: ${env('ALIYUN_FC_VPC_ID')}
  securityGroupId: ${env('ALIYUN_FC_SECURITY_GROUP_ID')}
  vSwitchIdPrimary: ${env('ALIYUN_FC_VSWITCH_ID_PRIMARY')}
  vSwitchIdSecondary: ${env('ALIYUN_FC_VSWITCH_ID_SECONDARY')}
  ossEndpoint: ${env('ALIYUN_FC_OSS_ENDPOINT')}
  ossBucket: ${env('ALIYUN_FC_OSS_BUCKET')}
  ossBucketPath: ${env('ALIYUN_FC_OSS_BUCKET_PATH')}

resources:
  backend:
    component: fc3
    props:
      region: ${vars.region}
      functionName: ${vars.functionName}
      handler: index.handler
      role: ${vars.roleArn}
      disableOndemand: false
      description: ""
      timeout: 60
      diskSize: 512
      memorySize: 512
      cpu: 0.35
      runtime: custom.debian12
      resourceGroupId: ${vars.resourceGroupId}
      instanceIsolationMode: SHARE
      instanceConcurrency: 20
      sessionAffinity: NONE
      tags:
        - Key: project
          Value: mvp-HA
      code: ./.fc-package
      customRuntimeConfig:
        port: 3000
        command:
          - bash
          - -c
          - ./fc-start.sh
        healthCheckConfig: {}
      logConfig:
        enableRequestMetrics: true
        enableInstanceMetrics: true
        logBeginRule: DefaultRegex
        project: ${vars.logProject}
        enableCustomExtraLog: true
        enableLlmMetrics: false
        logstore: ${vars.logStore}
      environmentVariables:
        PORT: "3000"
        NODE_ENV: production
        PATH: ${env('ALIYUN_FC_PATH')}
        NODE_PATH: /opt/nodejs/node_modules
        LD_LIBRARY_PATH: /code:/code/lib:/usr/lib:/opt/lib:/usr/local/lib
        TZ: Asia/Shanghai
        DATABASE_URL: ${env('DATABASE_URL')}
        WECHAT_OFFICIAL_ACCOUNT_APP_ID: ${env('WECHAT_OFFICIAL_ACCOUNT_APP_ID')}
        WECHAT_OFFICIAL_ACCOUNT_APP_SECRET: ${env('WECHAT_OFFICIAL_ACCOUNT_APP_SECRET')}
        FIXED_IP_HTTP_PROXY: ${env('FIXED_IP_HTTP_PROXY')}
        LLM_API_KEY: ${env('LLM_API_KEY')}
        LLM_BASE_URL: ${env('LLM_BASE_URL')}
        LLM_DEFAULT_MODEL: ${env('LLM_DEFAULT_MODEL')}
        FRONTEND_URL: ${env('FRONTEND_URL')}
        WECOM_TOKEN: ${env('WECOM_TOKEN')}
        WECOM_ENCODING_AES_KEY: ${env('WECOM_ENCODING_AES_KEY')}
        WECOM_CORP_ID: ${env('WECOM_CORP_ID')}
        WECOM_APP_AGENT_ID: ${env('WECOM_APP_AGENT_ID')}
        WECOM_APP_SECRET: ${env('WECOM_APP_SECRET')}
      vpcConfig:
        vpcId: ${vars.vpcId}
        securityGroupId: ${vars.securityGroupId}
        vSwitchIds:
          - ${vars.vSwitchIdPrimary}
          - ${vars.vSwitchIdSecondary}
      ossMountConfig:
        mountPoints:
          - endpoint: ${vars.ossEndpoint}
            bucketName: ${vars.ossBucket}
            bucketPath: ${vars.ossBucketPath}
            mountDir: /mnt/oss
            readOnly: false
      layers:
        - ${vars.nodeModulesLayerArn}
